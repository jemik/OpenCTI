# OpenCTI with Trend Vision One Threat Intelligence Feed Connector

This project provides a ready-to-run [OpenCTI](https://www.opencti.io/) stack (via Docker Compose) with **persistent storage** and a custom **Trend Vision One Threat Intelligence Feed connector**.  

The connector polls the Trend Micro Vision One Threat Intelligence Feed API (`/v3.0/threatintel/feeds`), retrieves intelligence in STIX 2.1 format, and ingests it directly into OpenCTI.

---

## üìÇ Project Structure

```
.
‚îú‚îÄ‚îÄ install_opencti.sh        # One-shot installer script
‚îú‚îÄ‚îÄ docker-compose.yml        # Generated by installer
‚îú‚îÄ‚îÄ connectors/
‚îÇ   ‚îî‚îÄ‚îÄ trend-v1-opencti/     # Custom Trend V1 connector
‚îÇ       ‚îú‚îÄ‚îÄ Dockerfile
‚îÇ       ‚îú‚îÄ‚îÄ requirements.txt
‚îÇ       ‚îî‚îÄ‚îÄ trend_v1_to_opencti.py
‚îî‚îÄ‚îÄ README.md                 # This file
```

---

## üöÄ Quick Start

1. **Set your Trend Vision One API key** (required):
   ```bash
   export TV1_API_KEY="YOUR_TREND_V1_API_KEY"
   ```

2. **(Optional) Apply a contextual filter**  
   Example: Finance sector in Denmark:
   ```bash
   export TV1_CONTEXTUAL_FILTER="location eq 'Denmark' and industry eq 'Finance'"
   ```

3. **Run the installer**:
   ```bash
   chmod +x install_opencti.sh
   sudo -E ./install_opencti.sh
   ```

4. **Access OpenCTI**:
   ```
   http://localhost:8080
   ```
   Default admin user:
   ```
   Email: admin@local
   Password: <printed by installer>
   ```

---

## ‚öôÔ∏è Configuration

All values can be customized via environment variables **before** running the installer.

| Variable                    | Default                                | Description |
|-----------------------------|----------------------------------------|-------------|
| `OPENCTI_PORT`              | `8080`                                | Port for OpenCTI web UI |
| `OPENCTI_ADMIN_EMAIL`       | `admin@local`                         | Initial admin email |
| `OPENCTI_ADMIN_PASS`        | (random)                              | Initial admin password |
| `TV1_API_KEY`               | (required)                            | Trend Vision One API key |
| `TV1_API_ROOT`              | `https://api.eu.xdr.trendmicro.com`   | API root (set region) |
| `TV1_CONTEXTUAL_FILTER`     | (empty)                               | Optional contextual filter |
| `CONNECTOR_POLL_MINUTES`    | `60`                                  | Time window for each poll |
| `CONNECTOR_SLEEP_SECONDS`   | `900` (15 min)                        | Delay between polls |
| `CONNECTOR_TOP_REPORT`      | `1000`                                | Max items per request |
| `CONNECTOR_RESPONSE_FORMAT` | `stixBundle`                          | `stixBundle` or `taxiiEnvelope` |

---

## üß© Contextual Filters

The connector supports **`TMV1-Contextual-Filter`**.  
Examples:

- **All reports for Canada**
  ```bash
  export TV1_CONTEXTUAL_FILTER="location eq 'Canada'"
  ```
- **Finance in Denmark**
  ```bash
  export TV1_CONTEXTUAL_FILTER="location eq 'Denmark' and industry eq 'Finance'"
  ```
- **Energy OR Healthcare industries**
  ```bash
  export TV1_CONTEXTUAL_FILTER="industry in ('Energy','Healthcare')"
  ```

Available values can be retrieved via:
```
GET /v3.0/threatintel/feeds/filterDefinition
```

---

## üíæ Persistent Storage

The following named Docker volumes ensure data persists across restarts:

- `esdata` ‚Üí Elasticsearch  
- `neo4jdata`, `neo4jlogs` ‚Üí Neo4j  
- `s3data` ‚Üí MinIO  
- `redisdata` ‚Üí Redis  
- `rabbitmqdata` ‚Üí RabbitMQ  
- `openctidata` ‚Üí OpenCTI platform  

---

## üîÑ Updating

To update the stack or connector:

```bash
cd /opt/opencti
docker compose pull
docker compose build connector-trend-v1
docker compose up -d
```

---

## üõ†Ô∏è Troubleshooting

- **Connector not ingesting data**  
  Check logs:
  ```bash
  docker compose logs -f connector-trend-v1
  ```
  Verify `TV1_API_KEY` and filter syntax.

- **Elasticsearch or Neo4j OOM errors**  
  Increase host RAM or adjust JVM heap sizes in `docker-compose.yml`.

- **API rate limiting (HTTP 429)**  
  The connector auto-retries. Reduce `CONNECTOR_TOP_REPORT` or increase `CONNECTOR_SLEEP_SECONDS`.

---

## üìö References

- [Trend Micro Vision One Threat Intelligence Feed API Docs](https://automation.trendmicro.com/xdr/api-v3/#tag/Trend-Threat-Intelligence-Feed/paths/~1v3.0~1threatintel~1feeds/get)  
- [OpenCTI Documentation](https://www.opencti.io/en/documentation)  
- [pycti Python Client](https://pypi.org/project/pycti/)  

---

## üìú License

Apache 2.0
